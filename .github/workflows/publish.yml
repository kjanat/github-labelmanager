name: Publish

on:
  push:
    tags: ["v*.*.*"]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  validate:
    name: Validate version
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Skip fork PRs for security
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
      is_tag: ${{ github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v6
      - name: Extract and validate version
        id: version
        run: |
          JSON_VERSION=$(jq -r '.version' deno.json)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR: use version from deno.json
            echo "PR mode: version from deno.json: $JSON_VERSION"
            VERSION="v$JSON_VERSION"
          else
            # Tag push: validate tag matches deno.json
            VERSION="$GITHUB_REF_NAME"
            SEMVER="${VERSION#v}"
            echo "Tag version: $SEMVER"
            echo "deno.json version: $JSON_VERSION"
            if [ "$SEMVER" != "$JSON_VERSION" ]; then
              echo "::error::Version mismatch: tag=$SEMVER, deno.json=$JSON_VERSION"
              exit 1
            fi
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if [[ "$VERSION" == *-* ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - uses: denoland/setup-deno@v2
        with: { deno-version: v2.x }
      - name: Build NPM package
        run: deno task build
      - name: Upload NPM artifact
        uses: actions/upload-artifact@v5
        with:
          name: npm-package
          path: npm/
          retention-days: 1
      - name: Validate JSR (dry-run)
        run: deno publish --dry-run

  publish:
    name: ${{ matrix.target == 'jsr' && (needs.validate.outputs.is_tag == 'true' && 'Publish to JSR' || 'JSR (dry-run)') || (needs.validate.outputs.is_tag == 'true' && 'Publish to NPM' || 'NPM (dry-run)') }}
    needs: [validate, build]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        target: [jsr, npm]
    steps:
      - uses: actions/checkout@v6

      # JSR
      - name: Setup Deno
        if: matrix.target == 'jsr'
        uses: denoland/setup-deno@v2
        with: { deno-version: v2.x }
      - name: Publish to JSR
        if: matrix.target == 'jsr' && needs.validate.outputs.is_tag == 'true'
        run: deno publish
      - name: JSR dry-run
        if: matrix.target == 'jsr' && needs.validate.outputs.is_tag != 'true'
        run: deno publish --dry-run

      # NPM
      - name: Download NPM artifact
        if: matrix.target == 'npm'
        uses: actions/download-artifact@v6
        with:
          name: npm-package
          path: npm/
      - name: Setup Node
        if: matrix.target == 'npm'
        uses: actions/setup-node@v6
        with:
          node-version: latest
          registry-url: https://registry.npmjs.org
      - name: Update npm
        if: matrix.target == 'npm'
        run: npm install -g npm@latest
      - name: Publish to NPM
        if: matrix.target == 'npm' && needs.validate.outputs.is_tag == 'true'
        working-directory: ./npm
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          SEMVER="${VERSION#v}"
          if [ "${{ needs.validate.outputs.prerelease }}" == "true" ]; then
            npm publish --access public --provenance --tag beta
          else
            npm publish --access public --provenance
            # Update beta dist-tag to point to stable (beta becomes alias)
            npm dist-tag add "@kjanat/github-labelmanager@$SEMVER" beta || echo "::warning::Failed to update beta dist-tag"
          fi
      - name: NPM dry-run
        if: matrix.target == 'npm' && needs.validate.outputs.is_tag != 'true'
        working-directory: ./npm
        run: npm publish --access public --dry-run

  release:
    name: Create GitHub Release
    needs: [validate, publish]
    if: needs.validate.outputs.is_tag == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
      - name: Create GitHub Release
        run: |
          if [ "${{ needs.validate.outputs.prerelease }}" == "true" ]; then
            gh release create ${{ github.ref_name }} --generate-notes --prerelease
          else
            gh release create ${{ github.ref_name }} --generate-notes
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  update-tags:
    name: Update version tags
    needs: [validate, release]
    if: needs.validate.outputs.is_tag == 'true' && needs.validate.outputs.prerelease != 'true'
    uses: ./.github/workflows/update-tags.yml
    with:
      version: ${{ needs.validate.outputs.version }}
    permissions:
      contents: write
