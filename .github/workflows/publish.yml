name: Publish

on:
  push:
    tags: ["v*.*.*"]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  validate:
    name: Validate version
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Skip fork PRs for security
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
      is_tag: ${{ github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v6
      # TODO: Convert `version` to github-script
      # - name: Extract and validate version
      #   id: version-github-script
      #   uses: actions/github-script@v8
      #   with:
      #     script: |
      #       const version = process.env.GITHUB_REF_NAME;
      #       console.log(`Version from GITHUB_REF_NAME: ${version}`);
      #       core.setOutput('version', version);
      - name: Extract and validate version
        id: version
        run: |
          JSON_VERSION=$(jq -r '.version' deno.json)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR: use version from deno.json
            echo "PR mode: version from deno.json: $JSON_VERSION"
            VERSION="v$JSON_VERSION"
          else
            # Tag push: validate tag matches deno.json
            VERSION="$GITHUB_REF_NAME"
            SEMVER="${VERSION#v}"
            echo "Tag version: $SEMVER"
            echo "deno.json version: $JSON_VERSION"
            if [ "$SEMVER" != "$JSON_VERSION" ]; then
              echo "::error::Version mismatch: tag=$SEMVER, deno.json=$JSON_VERSION"
              exit 1
            fi
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if [[ "$VERSION" == *-* ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - uses: denoland/setup-deno@v2
        with: { deno-version: v2.x }
      - name: Build NPM package
        run: deno task build
      - name: Upload NPM artifact
        uses: actions/upload-artifact@v5
        with:
          name: npm-package
          path: npm/
          retention-days: 1
      - name: Validate JSR (dry-run)
        run: deno publish --dry-run

  publish-jsr:
    name: JSR ${{ needs.validate.outputs.is_tag == 'true' && '(publish)' || '(dry-run)' }}
    needs: [validate]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions: { contents: read, id-token: write }
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/publish-jsr
        with:
          dry-run: ${{ needs.validate.outputs.is_tag != 'true' }}

  publish-npm:
    name: NPM ${{ needs.validate.outputs.is_tag == 'true' && '(publish)' || '(dry-run)' }}
    needs: [validate, build]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions: { contents: read, id-token: write }
    steps:
      - uses: actions/checkout@v6
      - uses: denoland/setup-deno@v2
        with: { deno-version: v2.x }
      - name: Build NPM package
        run: deno task build

      - name: Setup Node
        uses: actions/setup-node@v6
        with: { node-version: latest }

      - uses: ./.github/actions/publish-npm
        with:
          dry-run: ${{ needs.validate.outputs.is_tag != 'true' }}
          version: ${{ needs.validate.outputs.version }}
          prerelease: ${{ needs.validate.outputs.prerelease }}

  release:
    name: Create GitHub Release
    needs: [validate, publish-jsr, publish-npm]
    if: needs.validate.outputs.is_tag == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
      - name: Create GitHub Release
        run: |
          gh release create "${{ github.ref_name }}" \
            --generate-notes \
            ${{ needs.validate.outputs.prerelease == 'true' && '--prerelease' || '' }}
        env:
          GH_TOKEN: ${{ github.token }}

  update-tags:
    name: Update version tags
    needs: [validate, release]
    if: needs.validate.outputs.is_tag == 'true' && needs.validate.outputs.prerelease != 'true'
    uses: ./.github/workflows/update-tags.yml
    with:
      version: ${{ needs.validate.outputs.version }}
    permissions:
      contents: write
