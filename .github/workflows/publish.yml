name: Publish

on:
  push:
    tags: ["v*.*.*"]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  validate:
    name: Validate version
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Skip fork PRs for security
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_tag: ${{ steps.version.outputs.is_tag }}
      prerelease: ${{ steps.version.outputs.prerelease }}
      is_stable: ${{ steps.version.outputs.is_stable }}
      mode: ${{ steps.version.outputs.mode }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/release-validate
        id: version

  publish-jsr:
    name: JSR (${{ needs.validate.outputs.mode }})
    needs: [validate]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions: { contents: read, id-token: write }
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-deno
      - run: |
          # Extract package info from deno.json
          PKG_NAME="$(jq -r '.name' deno.json)"
          PKG_VERSION="$(jq -r '.version' deno.json)"

          # Check if version already published on JSR (skip on re-run)
          if [[ "${DRY_RUN}" != "true" ]]; then
            PUBLISHED=$(curl -sf "https://jsr.io/${PKG_NAME}/meta.json" | jq -r ".versions[\"${PKG_VERSION}\"] // empty" || true)
            if [[ -n "${PUBLISHED}" ]]; then
              echo "::notice::${PKG_NAME}@${PKG_VERSION} already published on JSR, skipping"
              exit 0
            fi
            deno publish && exit 0
          fi
          deno publish --dry-run
        env:
          DRY_RUN: ${{ needs.validate.outputs.is_tag != 'true' }}

  publish-npm:
    name: NPM (${{ needs.validate.outputs.mode }})
    needs: [validate]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions: { contents: read, id-token: write }
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-deno
        with:
          install-node: "true"
          update-npm: "true"
      - run: deno task build
      - uses: ./.github/actions/publish-npm
        with:
          dry-run: ${{ needs.validate.outputs.is_tag != 'true' }}
          prerelease: ${{ needs.validate.outputs.prerelease }}
          prerelease-tag: beta
          working-directory: npm

  release:
    name: Publish GitHub Release
    needs: [validate, publish-jsr, publish-npm]
    if: needs.validate.outputs.is_tag == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - name: Publish GitHub Release
        run: |
          # Publish existing draft from release-drafter, or create new release as fallback
          gh release edit "${TAG}" --repo "${REPO}" --draft=false ${PRERELEASE} 2>/dev/null \
          || gh release create "${TAG}" --repo "${REPO}" --generate-notes ${PRERELEASE}
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          TAG: ${{ github.ref_name }}
          PRERELEASE: ${{ needs.validate.outputs.prerelease == 'true' && '--prerelease' || '' }}

  update-tags:
    name: Update version tags
    needs: [validate, release]
    if: needs.validate.outputs.is_stable == 'true'
    permissions:
      contents: write
    uses: ./.github/workflows/update-tags.yml
    with:
      version: ${{ needs.validate.outputs.version }}
