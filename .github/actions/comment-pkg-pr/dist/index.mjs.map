{"version":3,"file":"index.mjs","names":["fsReadFileSync","prNumber: number | null","result: RunResult"],"sources":["../src/comment.ts","../src/format.ts","../src/run.ts","../src/index.ts"],"sourcesContent":["import type { CommentResult, Octokit } from \"./types.ts\";\n\ninterface CommentContext {\n  owner: string;\n  repo: string;\n}\n\n/**\n * Find existing bot comment by identifier string\n */\nexport async function findBotComment(\n  octokit: Octokit,\n  ctx: CommentContext,\n  issueNumber: number,\n  identifier: string,\n): Promise<{ id: number; url: string } | null> {\n  const { data: comments } = await octokit.rest.issues.listComments({\n    owner: ctx.owner,\n    repo: ctx.repo,\n    issue_number: issueNumber,\n  });\n\n  const found = comments.find((comment) => comment.body?.includes(identifier));\n  if (found) {\n    return { id: found.id, url: found.html_url };\n  }\n  return null;\n}\n\n/**\n * Create a new comment on an issue/PR\n */\nexport async function createComment(\n  octokit: Octokit,\n  ctx: CommentContext,\n  issueNumber: number,\n  body: string,\n): Promise<CommentResult> {\n  const { data } = await octokit.rest.issues.createComment({\n    owner: ctx.owner,\n    repo: ctx.repo,\n    issue_number: issueNumber,\n    body,\n  });\n\n  return { commentId: data.id, commentUrl: data.html_url };\n}\n\n/**\n * Update an existing comment\n */\nexport async function updateComment(\n  octokit: Octokit,\n  ctx: CommentContext,\n  commentId: number,\n  body: string,\n): Promise<CommentResult> {\n  const { data } = await octokit.rest.issues.updateComment({\n    owner: ctx.owner,\n    repo: ctx.repo,\n    comment_id: commentId,\n    body,\n  });\n\n  return { commentId: data.id, commentUrl: data.html_url };\n}\n\n/**\n * Create or update a comment (upsert pattern)\n */\nexport async function upsertComment(\n  octokit: Octokit,\n  ctx: CommentContext,\n  issueNumber: number,\n  body: string,\n  identifier: string,\n): Promise<CommentResult> {\n  const existing = await findBotComment(octokit, ctx, issueNumber, identifier);\n\n  if (existing) {\n    return updateComment(octokit, ctx, existing.id, body);\n  }\n  return createComment(octokit, ctx, issueNumber, body);\n}\n\n/**\n * Find PR number for a push event by matching branch\n */\nexport async function findPrForPush(\n  octokit: Octokit,\n  ctx: CommentContext,\n  ref: string,\n): Promise<number | null> {\n  const branch = ref.replace(\"refs/heads/\", \"\");\n  const { data: pullRequests } = await octokit.rest.pulls.list({\n    owner: ctx.owner,\n    repo: ctx.repo,\n    state: \"open\",\n    head: `${ctx.owner}:${branch}`,\n  });\n\n  return pullRequests[0]?.number ?? null;\n}\n","import type { OutputMetadata } from \"./types.ts\";\n\n/**\n * Format packages list for the comment body\n */\nexport function formatPackages(packages: OutputMetadata[\"packages\"]): string {\n  if (packages.length === 0) return \"_No packages published_\";\n  return packages.map((pkg) => `- \\`${pkg.name}\\`: ${pkg.url}`).join(\"\\n\");\n}\n\n/**\n * Format templates list for the comment body\n */\nexport function formatTemplates(\n  templates: OutputMetadata[\"templates\"],\n): string {\n  if (templates.length === 0) return \"_No templates available_\";\n  return templates.map((tmpl) => `- [${tmpl.name}](${tmpl.url})`).join(\"\\n\");\n}\n\n/**\n * Build the full comment body\n */\nexport function buildCommentBody(\n  output: OutputMetadata,\n  commitUrl: string,\n  identifier: string,\n): string {\n  const packages = formatPackages(output.packages);\n  const templates = formatTemplates(output.templates);\n\n  return `${identifier}\n\n### Published Packages\n\n${packages}\n\n### Templates\n\n${templates}\n\n[View Commit](${commitUrl})`;\n}\n\n/**\n * Build the step summary content (same as comment but with header)\n */\nexport function buildStepSummary(\n  output: OutputMetadata,\n  commitUrl: string,\n  prFound: boolean,\n): string {\n  const packages = formatPackages(output.packages);\n  const templates = formatTemplates(output.templates);\n  const prStatus = prFound\n    ? \":white_check_mark: Comment posted to PR\"\n    : \":information_source: No PR found, logged to console only\";\n\n  return `# pkg-pr-new Publish Results\n\n${prStatus}\n\n## Published Packages\n\n${packages}\n\n## Templates\n\n${templates}\n\n[View Commit](${commitUrl})`;\n}\n\n/**\n * Format log output for console\n */\nexport function formatLogOutput(\n  output: OutputMetadata,\n  commitUrl: string,\n): string {\n  const separator = \"=\".repeat(50);\n  const packages = output.packages\n    .map((pkg) => `  - ${pkg.name}: ${pkg.url}`)\n    .join(\"\\n\");\n  const templates = output.templates\n    .map((tmpl) => `  - ${tmpl.name}: ${tmpl.url}`)\n    .join(\"\\n\");\n\n  return `\n${separator}\nPublish Information\n${separator}\n\nPublished Packages:\n${packages || \"  (none)\"}\n\nTemplates:\n${templates || \"  (none)\"}\n\nCommit URL: ${commitUrl}\n${separator}`;\n}\n","import * as core from \"@actions/core\";\nimport { context, getOctokit } from \"@actions/github\";\nimport type { PullRequestEvent, PushEvent } from \"@octokit/webhooks-types\";\nimport { readFileSync as fsReadFileSync } from \"node:fs\";\n\nimport { findPrForPush, upsertComment } from \"./comment.ts\";\nimport {\n  buildCommentBody,\n  buildStepSummary,\n  formatLogOutput,\n} from \"./format.ts\";\nimport type { ActionInputs, OutputMetadata, RunResult } from \"./types.ts\";\n\n/** Type for readFileSync function (for dependency injection in tests) */\nexport type ReadFileFn = (path: string, encoding: BufferEncoding) => string;\n\n/**\n * Get inputs from action.yml\n */\nexport function getInputs(): ActionInputs {\n  return {\n    githubToken: core.getInput(\"github-token\", { required: true }),\n    outputFile: core.getInput(\"output-file\") || \"output.json\",\n    commentIdentifier: core.getInput(\"comment-identifier\") ||\n      \"## pkg-pr-new publish\",\n  };\n}\n\n/**\n * Load and parse the pkg-pr-new output file\n */\nexport function loadOutputFile(\n  filePath: string,\n  readFile: ReadFileFn = fsReadFileSync,\n): OutputMetadata {\n  const content = readFile(filePath, \"utf8\");\n  return JSON.parse(content) as OutputMetadata;\n}\n\n/**\n * Get the commit SHA based on event type\n */\nexport function getCommitSha(): string {\n  if (context.eventName === \"pull_request\") {\n    const payload = context.payload as PullRequestEvent;\n    return payload.pull_request.head.sha;\n  }\n  if (context.eventName === \"push\") {\n    const payload = context.payload as PushEvent;\n    return payload.after;\n  }\n  throw new Error(`Unsupported event type: ${context.eventName}`);\n}\n\n/**\n * Build the commit URL\n */\nexport function buildCommitUrl(sha: string): string {\n  return `https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${sha}`;\n}\n\n/**\n * Main run logic\n * @param readFile - Optional readFile function for testing (defaults to fs.readFileSync)\n */\nexport async function run(\n  readFile: ReadFileFn = fsReadFileSync,\n): Promise<RunResult> {\n  const inputs = getInputs();\n  const octokit = getOctokit(inputs.githubToken);\n  const ctx = { owner: context.repo.owner, repo: context.repo.repo };\n\n  // Load output file\n  core.info(`Loading output file: ${inputs.outputFile}`);\n  const output = loadOutputFile(inputs.outputFile, readFile);\n  core.info(\n    `Found ${output.packages.length} packages, ${output.templates.length} templates`,\n  );\n\n  // Get commit info\n  const sha = getCommitSha();\n  const commitUrl = buildCommitUrl(sha);\n  core.info(`Commit: ${sha}`);\n\n  // Build comment body\n  const body = buildCommentBody(output, commitUrl, inputs.commentIdentifier);\n\n  // Find PR number\n  let prNumber: number | null = null;\n\n  if (context.eventName === \"pull_request\") {\n    prNumber = context.issue.number;\n  } else if (context.eventName === \"push\") {\n    core.info(\"Push event - searching for associated PR...\");\n    prNumber = await findPrForPush(octokit, ctx, context.ref);\n    if (prNumber) {\n      core.info(`Found PR #${prNumber}`);\n    } else {\n      core.info(\"No open PR found for this branch\");\n    }\n  }\n\n  // Result to return\n  const result: RunResult = { prFound: prNumber !== null };\n\n  // Post comment if PR found\n  if (prNumber) {\n    core.info(`Posting comment to PR #${prNumber}...`);\n    const commentResult = await upsertComment(\n      octokit,\n      ctx,\n      prNumber,\n      body,\n      inputs.commentIdentifier,\n    );\n    result.commentId = commentResult.commentId;\n    result.commentUrl = commentResult.commentUrl;\n    core.info(`Comment posted: ${commentResult.commentUrl}`);\n  } else {\n    // Log to console if no PR\n    core.info(formatLogOutput(output, commitUrl));\n  }\n\n  // Write step summary\n  const summary = buildStepSummary(output, commitUrl, result.prFound);\n  await core.summary.addRaw(summary).write();\n\n  // Set outputs\n  core.setOutput(\"pr-found\", result.prFound.toString());\n  core.setOutput(\"comment-id\", result.commentId?.toString() ?? \"\");\n  core.setOutput(\"comment-url\", result.commentUrl ?? \"\");\n\n  return result;\n}\n","import * as core from \"@actions/core\";\n\nimport { run } from \"./run.ts\";\n\nasync function main(): Promise<void> {\n  try {\n    await run();\n  } catch (error) {\n    if (error instanceof Error) {\n      core.error(error.stack ?? error.message);\n      core.setFailed(error.message);\n    } else {\n      core.setFailed(String(error));\n    }\n  }\n}\n\nmain();\n"],"mappings":"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"}